<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Login</title>
    <!-- plugins:css -->
    <link
      rel="stylesheet"
      href="../../public/vendors/mdi/css/materialdesignicons.min.css"
    />

    <link rel="stylesheet" href="../../public/css/style.css" />
    <link rel="stylesheet" href="../../public/css/style.css" />

    <link rel="stylesheet" href="../../public/css/responsive.css" />
    <link rel="stylesheet" href="../../public/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../public/DataTables/datatables.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/n+pm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <style>
      .password-field-hidden {
        display: none;
      }
      .input-container {
        position: relative;
      }
      .fa-check {
        position: absolute;
        right: 10px;
        top: 70%;
        transform: translateY(-50%);
        color: green;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="alert1" id="message-panel" style="display: none"></div>

    <div class="container-fluid forgot-bg">
      <div class="container login-main-panel">
        <div class="row py-4 d-flex align-items-center justify-content-center">
          <div class="col-md-6">
            <div class="login-content">
              <form id="forgot-password-form">
                <div
                  class="login-logo d-flex align-items-center justify-content-center pb-4"
                >
                  <img src="../../public/images/Group 46 (1).jpg" alt="" />
                </div>
                <div class="mb-3">
                  <label class="form-label">Email address</label>
                  <input
                    type="email"
                    class="form-control"
                    name="email"
                    placeholder="Enter Email Address"
                    required
                  />
                </div>

                <input type="tel" style="display: none" />
                <div
                  class="mb-3 position-relative password-field-hidden"
                  id="otp-field"
                >
                  <label class="form-label">ENTER OTP</label>
                  <input
                    type="tel"
                    name="otp"
                    maxlength="6"
                    pattern="\d{6}"
                    class="form-control"
                    id="otp"
                    placeholder="Enter OTP"
                    required
                  />
                  <i id="otp-success-icon" class="fa-solid fa-check"></i>
                </div>

                <input type="password" style="display: none" />
                <div
                  class="mb-3 position-relative password-field-hidden"
                  id="password-field"
                >
                  <label class="form-label">Password</label>
                  <input
                    type="password"
                    id="password"
                    class="form-control"
                    name="password"
                    placeholder="Create a New Password"
                    autocomplete="new-password"
                  />
                  <span class="password-icon">
                    <i class="bi bi-eye-slash" id="togglePassword"></i>
                  </span>
                </div>

                <div class="login-btn d-flex justify-content-center">
                  <button type="button" class="btn" id="resetPasswordButton">
                    Reset Password
                  </button>
                  <button
                    type="button"
                    class="btn"
                    id="verifyOtpButton"
                    style="display: none"
                  >
                    Verify OTP
                  </button>
                  <button
                    type="button"
                    class="btn"
                    id="submitPasswordButton"
                    style="display: none"
                  >
                    Submit
                  </button>
                </div>

                <div
                  class="login-forgot-password d-flex justify-content-center"
                >
                  <a href="/login_role">Already a User? Log in</a>
                </div>
                <div
                  class="alert"
                  id="message-panel"
                  style="display: none"
                ></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- main-panel ends -->
    <script src="/src/public/js/jquery.min.js"></script>
    <script src="../../public/vendors/js/vendor.bundle.base.js"></script>
    <script src="../../public/js/bootstrap.min.js"></script>
    <!-- End custom js for this page -->
    <!-- <script>
      document;

      function showMessage(message) {
        var messagePanel = document.getElementById("message-panel");
        messagePanel.textContent = message;
        messagePanel.style.display = "block";

        // Hide the message panel after 3 seconds
        setTimeout(function () {
          messagePanel.style.display = "none";
        }, 3000); // 3000 milliseconds = 3 seconds
      }

      function submitPasswordChange() {
        const form = document.getElementById("forgotPasswordForm");
        const email = form.querySelector('input[name="email"]').value;
        const otp = form.querySelector('input[name="otp"]').value;
        const password = form.querySelector('input[name="password"]').value;
        // const passwordField = document.querySelector("#password-field");
        const verifyOtpButton = document.querySelector("#verifyOtpButton");
        const successIcon = document.getElementById("otp-success-icon");
      }

      document
        .getElementById("resetPasswordButton")
        .addEventListener("click", function () {
          fetch("/forgot_email_check", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: document.querySelector('input[name="email"]').value,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.exists) {
                // Email exists, reveal password and OTP fields
                // document
                //   .getElementById("password-field")
                //   .classList.remove("password-field-hidden");
                document
                  .getElementById("otp-field")
                  .classList.remove("password-field-hidden");
                document.getElementById("resetPasswordButton").style.display =
                  "none";
                document.getElementById("submitPasswordButton").style.display =
                  "block";
              } else {
                // Email does not exist, display message
                var messagePanel = document.getElementById("message-panel");
                messagePanel.textContent = "User not exist";
                messagePanel.style.display = "block";
                setTimeout(() => {
                  messagePanel.style.display = "none";
                }, 3000);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

      document
        .getElementById("verifyOtpButton")
        .addEventListener("click", function () {
          fetch("/forgot_password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: document.querySelector('input[name="email"]').value,
              otp: document.getElementById("otp").value,
              // password: document.getElementById("password").value,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                var messagePanel = document.getElementById("message-panel");
                messagePanel.textContent = "Password changed successfully";
                messagePanel.style.display = "block";
                setTimeout(() => {
                  window.location.href = "/dashboard";
                }, 2000);
              } else {
                var messagePanel = document.getElementById("message-panel");
                messagePanel.textContent =
                  data.message || "Failed to change password";
                messagePanel.style.display = "block";
                setTimeout(() => {
                  messagePanel.style.display = "none";
                }, 3000);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

      document
        .getElementById("togglePassword")
        .addEventListener("click", function () {
          var passwordInput = document.getElementById("password");
          var togglePasswordIcon = document.getElementById("togglePassword");
          if (passwordInput.type === "password") {
            passwordInput.type = "text";
            togglePasswordIcon.classList.remove("bi-eye-slash");
            togglePasswordIcon.classList.add("bi-eye");
          } else {
            passwordInput.type = "password";
            togglePasswordIcon.classList.remove("bi-eye");
            togglePasswordIcon.classList.add("bi-eye-slash");
          }
        });

      document
        .getElementById("toggleotp")
        .addEventListener("click", function () {
          var otpInput = document.getElementById("otp");
          var toggleOtpIcon = document.getElementById("toggleotp");
          if (otpInput.type === "password") {
            otpInput.type = "text";
            toggleOtpIcon.classList.remove("bi-eye-slash");
            toggleOtpIcon.classList.add("bi-eye");
          } else {
            otpInput.type = "password";
            toggleOtpIcon.classList.remove("bi-eye");
            toggleOtpIcon.classList.add("bi-eye-slash");
          }
        });
    </script> -->

    <script>
      const successIcon = document.getElementById("otp-success-icon");
      function showMessage(message) {
        var messagePanel = document.getElementById("message-panel");
        messagePanel.textContent = message;
        messagePanel.style.display = "block";

        // Hide the message panel after 3 seconds
        setTimeout(function () {
          messagePanel.style.display = "none";
        }, 3000); // 3000 milliseconds = 3 seconds
      }

      document
        .getElementById("resetPasswordButton")
        .addEventListener("click", function () {
          fetch("/forgot_email_check", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: document.querySelector('input[name="email"]').value,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.exists) {
                document
                  .getElementById("otp-field")
                  .classList.remove("password-field-hidden");
                document.getElementById("resetPasswordButton").style.display =
                  "none";
                document.getElementById("verifyOtpButton").style.display =
                  "block";
              } else {
                showMessage("User does not exist");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

      document
        .getElementById("verifyOtpButton")
        .addEventListener("click", function () {
          fetch("/verify", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: document.querySelector('input[name="email"]').value,
              otp: document.getElementById("otp").value,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                successIcon.style.display = "block";

                document
                  .getElementById("password-field")
                  .classList.remove("password-field-hidden");
                document.getElementById("verifyOtpButton").style.display =
                  "none";
                document.getElementById("submitPasswordButton").style.display =
                  "block";
              } else {
                successIcon.style.display = "none";

                showMessage("Invalid OTP");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

      document
        .getElementById("submitPasswordButton")
        .addEventListener("click", function () {
          fetch("/verifed", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: document.querySelector('input[name="email"]').value,
              otp: document.getElementById("otp").value,
              password: document.getElementById("password").value,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showMessage("Password changed successfully");
                setTimeout(() => {
                  if (data.role == "distributor") {
                    window.location.href = "/login_role";
                  } else window.location.href = "/dashboard";
                }, 2000);
              } else {
                showMessage(data.message || "Failed to change password");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });

      document
        .getElementById("togglePassword")
        .addEventListener("click", function () {
          var passwordInput = document.getElementById("password");
          var togglePasswordIcon = document.getElementById("togglePassword");
          if (passwordInput.type === "password") {
            passwordInput.type = "text";
            togglePasswordIcon.classList.remove("bi-eye-slash");
            togglePasswordIcon.classList.add("bi-eye");
          } else {
            passwordInput.type = "password";
            togglePasswordIcon.classList.remove("bi-eye");
            togglePasswordIcon.classList.add("bi-eye-slash");
          }
        });

      document
        .getElementById("toggleotp")
        .addEventListener("click", function () {
          var otpInput = document.getElementById("otp");
          var toggleOtpIcon = document.getElementById("toggleotp");
          if (otpInput.type === "password") {
            otpInput.type = "text";
            toggleOtpIcon.classList.remove("bi-eye-slash");
            toggleOtpIcon.classList.add("bi-eye");
          } else {
            otpInput.type = "password";
            toggleOtpIcon.classList.remove("bi-eye");
            toggleOtpIcon.classList.add("bi-eye-slash");
          }
        });
    </script>
  </body>
</html>
